= Introduction

Banana Pi M5 is a new generation single board computer design , use Amlogic S905X3 Quad-Core Cortex-A55 (2.0xxGHz) Processor. Mali-G31 MP2 GPU with 4 x Execution Engines (650Mhz). support 4GB LPDDR4 and 16G eMMC flash. it have 4 USB 3.0 port,1GbE LAN port, IR Reciver, Audio Jack, 1 HDMI Out and USB type-c power supply.

Banana Pi M2Pro is the same SOC with M5, but different board layout. 2GB LPDDR4 and 16G eMMC flash, 2 USB 3.0 port,1GbE LAN port, rtl8821cu usb wifi/bt onboard, IR Reciver, 1 HDMI Out, 1 MicroUSB port, DC power supply.

TIP: More Infomation: link:/en/BPI-M5/BananaPi_BPI-M5[Banana Pi BPI-M5] +
More Infomation: link:/en/BPI-M2_Pro/BananaPi_BPI-M2_Pro[Banana Pi BPI-M2_Pro]

== specifications

- SoC – Amlogic S905X3 quad-core Cortex-A55 processor @ up to 2.0 GHz with
Mali-G31 MP2 GPU @ 650Mhz
- System Memory – 4GB LPDDR4
- Storage – 16GB eMMC flash (option up to 64GB), MicroSD slot up to 2TB
- Video Output – HDMI 2.1 up to 4Kp60 with HDR, CEC, EDID
- Audio – 3.5mm audio jack, digital HDMI audio
- Connectivity – Gigabit Ethernet
- USB – 4x USB 3.0 ports via VL817 hub controller, 1x USB-C port (for power only?)
- Expansion – 40-pin Raspberry Pi header with 28x GPIO, UART, I2C, SPI, PWM, and power signal (+5V, +3.3V, GND).
- Debugging – 3-pin debug header
- Misc – Reset, Power, and U-boot button; power and activity LED’s; IR receiver
- Power Supply – 5V @3A via USB Type-C port
- Dimensions – 92x60mm (Not the same as Raspberry Pi PCB size, but they probably included the connectors during measurement)
- Weight – 48grams

= Development
== Prepare

. Prepare a usb-serial cable, a 5V/3A adaptor type-c power supply. The serial cable is used for console debug and type-c cable is used for android image download and ADB debug. M2pro is used Micro-usb port for android image download and ADB debug.
. Prepare a SDcard at least 8GB for linux development, android only support emmc boot.
. The SOC rom first boot media is emmc, so board can't bootup from SDcard if the emmc is bootable with any image flashed, more info please refer to board boot sequence.
. In Android SDcard is mmc0, emmc is mmc1, but in Linux SDcard is mmc1, emmc is mmc0.

== Android
=== Prepare

. Download and install the link:https://download.banana-pi.dev/d/3ebbfa04265d4dddb81b/files/?p=%2FTools%2Fimage_download_tools%2Faml_usb_burning_tool_V2_setup_v2.2.3.3.zip[AML Usb Burning Tool] for android image download via USB type-c on M5 and Micro-usb on M2pro, only support windows.
. Download the latest android image, and confirm that the md5 checksum is correct.
. M5 and M2pro are compatiable with same android image.

=== Install Image with Usb Burning Tool

. Open USB_Burning_Tool.exe, select menu File->Import image, choose the android image file aml_upgrade_package.img.
+
image::/picture/m5_android_install_1.png[m5_android_install_1.png]

. M5/M2pro board disconnect power, press and hold SW4 button beside 40pin header, plugin type-c usb cable(microUSB on m2pro) to PC
+
image::/picture/m5_android_install_2.png[m5_android_install_2.png]

. Click the Start button and wait for upgrade complete.
+
image::/picture/m5_android_install_3.png[m5_android_install_3.png]

. After Burning successfull, Unplug the usb and connect to power supply adaptor to startup.
+
image::/picture/m5_android_install_4.png[m5_android_install_4.png]

. Click the Stop button to cancel the upgrade process and close the USB Buring Tool.

=== Install Image with Aml Flash Tool
link:https://github.com/Dangku/aml-flash-tool[Aml-flash-tool] is a linux platform opensource image flash util for Amlogic android.
```sh

 $ ./flash-tool.sh --img=/path/to/aml_upgrade_package.img --parts=all --wipe --soc=g12a --reset=y
```
image::/picture/m5_linux_flash.png[m5_linux_flash.png]


=== Build Android Source Code
. Get Android 9.0 source code
+
```sh
 $ git clone https://github.com/BPI-SINOVOIP/BPI-S905X3-Android9
```
+
or you can get the source code tar archive from link:https://pan.baidu.com/s/1TmmR_075b49lPSt1Phq0ag?pwd=8888[Baidu Pan(pincode: 8888)] or link:https://drive.google.com/drive/folders/1RuvazYcr46HKMvNBxSqQftdyWa0tK9f7?usp=share_link[Google Drive]
+
. Build the Android 9.0 Source code
Please read the source code link:https://github.com/BPI-SINOVOIP/BPI-S905X3-Android9/blob/master/README.md[README.md]

=== Android DTB overlay
Bananapi M5/M2Pro DTBO idx value table, default idx value is 0 in release image.

[options="header" cols="1,1,2" width="70%"]
|=====
3+| Bananapi M5/M2pro DTBO idx value table 
| idx value | device tree overlay | description                         
| 0         | android_p_overlay   | default dtbo, no use                
| 1         | wifi_bt_rtl8822cs   | enable bpi rtl8822cs wifi/bt module 
| 2         | i2c2                | enable i2c 2                        
| 3         | i2c3                | enable i2c 3                        
| 4         | sdio                | enable sdio                         
| 5         | uart1               | enable 2 pins uart 1                
| 6         | uart1_cts_rts       | enable 4 pins uart 1                
| 7         | uart2               | enable 2 pins uart 2                
| 8         | hifi_pcm5122        | enable i2s link:https://shumeipai.nxez.com/hifidac-hat-for-raspberry-pi[pcm5122 HiFi DAC]
|=====

**How to apply a new dtbo**

. ADB command via sysfs
+
```sh
 root@dangku-desktop:/tmp# adb root
 restarting adbd as root
 root@dangku-desktop:/tmp# adb remount
 remount succeeded
 root@dangku-desktop:/tmp# adb shell
 bananapi_m5:/ # echo dtbo > /sys/class/unifykeys/name
 bananapi_m5:/ # echo "1" > /sys/class/unifykeys/write
 bananapi_m5:/ # reboot
```
. Uart console command via sysfs
+
```sh
 console:/ $ 
 console:/ $ su
 console:/ # echo dtbo > /sys/class/unifykeys/name
 [  115.702781@0] unifykey: name_store() 1302, name dtbo, 4
 [  115.702856@0] unifykey: name_store() 1311
 console:/ #
 console:/ # echo "1" > /sys/class/unifykeys/write
 [  129.262659@0] unifykey: write_store()  is a string
 [  129.262733@0] unifykey: dtbo, 1, 1
 [  129.265312@0] unifykey: amlkey_write 393
 [  129.292347@1] emmc_key_write:149, write ok
 console:/ # 
 console:/ # reboot
```
. Settings App(To-Do) +
Check the bootup uart debug message and confirm which dtbo is loaded actually, here "1" means set idx=1 to apply wifi_bt_rtl8822cs dtbo.
+
```sh
 load dtb from 0x1000000 ......
       Amlogic multi-dtb tool
       Single dtb detected
 find 2 dtbos
 dtbos to be applied: 1
 Apply dtbo 1
```
+
Unifykeys is stored in a specific emmc part, "Normal erase" selected in USB_Burning_Tool will not erase this data for next update, you must select "Erase all" if you want the default dtbo idx to be applied after image download.
+
image::/picture/m5_android_erase_all.png[m5_android_erase_all.png]

**Build Android image with a specific DTBO default.**

. Default build-in overlays are defined in device/amlogic/bananapi_m5/Kernel.mk, you can add a new overlay dtbo here.
+
```sh
 DTBO_DEVICETREE := android_p_overlay wifi_bt_rtl8822cs i2c2 i2c3 sdio uart1 uart1_cts_rts uart2 hifi_pcm5122
```
. Default apply DTBO idx is defined in device/amlogic/bananapi_m5/BoardConfig.mk, you can change the idx value to set which overlay dtbo will be applied default.
+
```sh
 BOARD_KERNEL_CMDLINE += androidboot.dtbo_idx=0
```
. DTS files are in common/arch/arm/boot/dts/amlogic/overlay/bananapi_m5/
More info about android device tree overlays, please refer to link:https://source.android.com/devices/architecture/dto[google android offical site]

=== Install OpenGapps
. Download install package from link:https://opengapps.org/[OpenGapps], Android release image is arm/android 9.0 variant.
+
image::/picture/opengapps.png[opengapps.png]

. Download link:https://download.banana-pi.dev/d/ca025d76afd448aabc63/files/?p=%2FTools%2Fapps%2Fdevice_id_v1.3.2.apk[device_id.apk].
. Copy the OpenGapp package to a udisk or sdcard root directory.
. Create a txt file named factory_update_param.aml in udisk or sdcard root directory with the following android recovery parameter content, and replace the file name with the actual downloaded package. +
udisk:
+
```
 --wipe_cache
 --update_package=/udisk/open_gapps-arm-9.0-pico-20210327.zip
```
sdcard:
+
```
 --wipe_cache
 --update_package=/sdcard/open_gapps-arm-9.0-pico-20210327.zip
```

. Plugin the udisk or sdcard to the board and poweron.

. OpenGapps install and certify.
+
https://youtu.be/fXOKmWfpqF8
+
watch this video on link:https://www.bilibili.com/video/BV13y4y1s77i/[bilibili]

=== IR Remote Control Custom
Before starting this work, some android basic concepts and knowledge need to be known.

- Linux kernel input key event.
- Android keycode.
- Linux keycode map to android keycode.
- Android Adb function work on your PC
--
. pull the remote files from device
+
```
 # adb pull /vendor/etc/remote.cfg
 # adb pull /vendor/etc/remote.tab 
```

. modify remote.cfg to enable remote debug message
+
image::/picture/remotecfg.png[remotecfg.png]
+
push remote.cfg back
+
```
 # adb root
 # adb remount
 # adb push remote.cfg /vendor/etc/
 # adb shell
 m5_mbox:/ # chmod 644 /vendor/etc/remote.cfg
 m5_mbox:/ # remotecfg -c /vendor/etc/remote.cfg -d
 cfgdir = /vendor/etc/remote.cfg
 work_mode = 1
 repeat_enable = 0
 debug_enable = 1
 max_frame_time = 1000
```

. Get the remote keycode +
Press your remote key one by one and then print the dmesg to get the remote custom_code and each remote key code.
+
```
 # adb shell dmesg | grep framecode=
```
+
image::/picture/keycode.png[keycode.png]
+
custom_code = 0xfe01 +
keycode = 0x00, 0x01, 0x09, 0x02, 0x0a, 0x05, 0x04 0x06, 0x03, 0x0b, 0x40, 0x48, 0x44

. Modify remote.tab to map the scancode to android keycode
+
image::/picture/remotetab.png[remotetab.png]
+
push remote.tab and test each key whether works
+
```
 # adb root
 # adb remount
 # adb push remote.tab1 /vendor/etc/
 # adb shell
 m5_mbox:/ # chmod 644 /vendor/etc/remote.tab
 m5_mbox:/ # remotecfg -c /vendor/etc/remote.cfg -t /vendor/etc/remote.tab -d
 cfgdir = /vendor/etc/remote.cfg
 work_mode = 1
 repeat_enable = 0
 debug_enable = 1
 max_frame_time = 1000
 tabdir = /vendor/etc/remote.tab
 custom_name = nec-test
 fn_key_scancode = 0xffff
 cursor_left_scancode = 0xffff
 cursor_right_scancode = 0xffff
 cursor_up_scancode = 0xffff
 cursor_down_scancode = 0xffff
 cursor_ok_scancode = 0xffff
 custom_code = 0xfe01
 release_delay = 80
 map_size = 13
 key[0] = 0x74
 key[1] = 0x1008b
 key[2] = 0x90066
 key[3] = 0x20069
 key[4] = 0xa006a
 key[5] = 0x50067
 key[6] = 0x4006c
 key[7] = 0x6001c
 key[8] = 0x30072
 key[9] = 0xb0073
 key[10] = 0x40009e
 key[11] = 0x4800a4
 key[12] = 0x440071
```

. Reboot the board 
--

== Linux
=== Prepare

. Linux image support SDcard or EMMC bootup, but you should read the boot sequence at first.
. It’s recommended to use A1 rated cards, 8GB at least.
. M5 and M2pro are compatiable with same Linux image.
. Make sure bootable EMMC is formatted if you want bootup from SDcard
. Make sure SDcard is formatted without Linux image flashed if you want bootup from EMMC and use Sdcard as storage.

=== Install Image to SDcard
**Windows**

Install Image with Balena Etcher. +
link:https://balena.io/etcher[Balena Etcher] is an opensource GUI flash tool by Balena, Flash OS images to SDcard or USB drive

image::/picture/etcher.jpg[etcher.jpg]

**Linux**

. Install Image with Balena Cli. +
link:https://github.com/balena-io/balena-cli[Balena CLI] is a Command Line Interface for balenaCloud or openBalena. It can be used to flash linux image. Download the installer or standalone package from link:https://github.com/balena-io/balena-cli/releases[balena-io] and link:https://github.com/balena-io/balena-cli/blob/master/INSTALL.md[install ]it correctly to your PC, then you can use the "link:https://docs.balena.io/reference/balena-cli/#local-flash-image[local flash]" command option of balena to flash a linux image to sdcard or usb drive.
+
```sh
 $ sudo balena local flash path/to/xxx-bpi-m5-xxx.img.zip
 $ sudo balena local flash path/to/xxx-bpi-m5-xxx.img.zip --drive /dev/disk2
 $ sudo balena local flash path/to/xxx-bpi-m5-xxx.img.zip --drive /dev/disk2 --yes
```

. Install Image with dd command on Linux, umount SDcard device /dev/sdX partition if mounted automatically. Actually bpi-copy is the same as this dd command.
+
```sh
 $ sudo apt-get install pv unzip
 $ sudo unzip -p xxx-bpi-m5-xxx.img.zip | pv | dd of=/dev/sdX bs=10M status=noxfer
```
. Install image with bpi-tools on Linux, plug SDcard to Linux PC and run
+
```sh
 $ sudo apt-get install pv unzip
 $ sudo bpi-copy xxx-bpi-m5-xxx.img.zip /dev/sdX
```

=== Install Image to eMMC

. Prepare a SDcard with Linux image flashed and bootup board with this SDcard.
. Copy Linux image to udisk, plug the udisk to board and mount it.
. There are two ways to install the linux image to board.
- Install with dd command, umount mmcblk0p1 and mmcblk0p2 partition if mounted automatically. Actually bpi-copy is the same as this dd command.
+
```sh
 $ sudo apt-get install pv unzip
 $ sudo unzip -p xxx-bpi-m5-xxx.img.zip | pv | dd of=/dev/mmcblk0 bs=10M status=noxfer
```
- Install the linux image in udisk with bpi-tools command
+
```sh
 $ sudo apt-get install pv unzip
 $ sudo bpi-copy xxx-bpi-m5-xxx.img.zip /dev/mmcblk0
```
. After download complete, power off safely and eject the SDcard.

=== Build Linux Source Code
. Get the Linux bsp source code
+
```sh
 $  git clone https://github.com/BPI-SINOVOIP/BPI-M5-bsp
```
. Build the bsp source code +
Please read the source code link:https://github.com/BPI-SINOVOIP/BPI-M5-bsp/blob/master/README.md[README.md]
. If you want build uboot and kernel separately, please download the link:https://github.com/Dangku/amlogic-u-boot/tree/odroidg12-v2015.01-c4-m5[u-boot] the link:https://github.com/Dangku/amlogic-linux/tree/odroidg12-4.9.y-c4-m5[kernel] only, get the toolchains, boot script and other configuration files from link:https://github.com/BPI-SINOVOIP/BPI-M5-bsp[BPI-M5-bsp]

=== DTB overlay
. DTB overlay is used for 40pin gpios multi-function configuration and install in vfat boot partition, you can check the mount point with mount command.
+
```sh
 root@bananapi:~# ls /boot/overlays/
 custom_ir.dtbo      pwm_b-backlight.dtbo  spi0.dtbo
 ds3231.dtbo         pwm_c-beeper.dtbo     uart1_cts_rts.dtbo
 hifi_pcm5102a.dtbo  pwm_cd-c.dtbo         uart1.dtbo
 hifi_pcm5122.dtbo   pwm_cd.dtbo           uart2.dtbo
 i2c0.dtbo           pwm_ef.dtbo           waveshare_tft24_lcd.dtbo
 i2c1.dtbo           pwm_ef-f.dtbo         waveshare_tft35c_lcd.dtbo
 pwm_ab.dtbo         sdio.dtbo             waveshare_tft35c_rtp.dtbo
```
. Update the overlays env in vfat /boot/boot.ini to enable what you want. Default i2c0, spi0 and uart1 enabled.
+
```sh
 # Overlays to load
 # Example combinations:
 #   spi0 i2c0 i2c1 uart0
 #   hktft32
 #   hktft35
 setenv overlays "i2c0 spi0 uart1"
```
. Must be restart the board for overlay dtb loaded.

=== WiringPi
WARNING: Note: This WiringPi only support set 40pin gpio to output, input or software pwm, for io functions as i2c, spi, pwm..., you must enable dtb overlay in boot.ini

. Build and install wiringPi, for debian, you must install sudo before build
+
```sh
 $ sudo apt-get update
 $ sudo apt-get install build-essential git
 $ git clone https://github.com/BPI-SINOVOIP/amlogic-wiringPi
 $ cd amlogic-wiringPi
 $ chmod a+x build
 $ sudo ./build
```
. Run gpio readall to show all 40pins status.
+
image::/picture/m5_wiringpi.png[m5_wiringpi.png]

. BPI GPIO Extend board and examples in link:https://github.com/BPI-SINOVOIP/amlogic-wiringPi/tree/master/examples[amlogic-wiringPi/examples]
+
blinkall, blink all pin header gpios, no extend board. +
lcd-bpi, link:https://wiki.banana-pi.org/BPI_LCD_1602_display_module[BPI LCD 1602 display module] example. +
52pi-bpi, link:https://wiki.banana-pi.org/BPI_OLED_Display_Module[BPI OLED Display Module] example. +
matrixled-bpi, link:https://wiki.banana-pi.org/BPI_RGB_LED_Matrix_Expansion_Module[BPI RGB LED Matrix Expansion Module] example. +
berryclip-bpi, link:https://wiki.banana-pi.org/BPI_BerryClip_Module[BPI BerryClip Module]

=== RPi.GPIO

Build and install, for debian, you must link:https://newwiki.banana-pi.org/en/BPI-M5_M2_Pro/GettingStarted_BPI-M5_M2_Pro#_enable_sudo_for_debian[install sudo] before build
```sh
 $ sudo apt-get update
 $ sudo apt-get install build-essential python3 python3-pip python3-dev python3-setuptools git
 $ git clone https://github.com/Dangku/RPi.GPIO-Amlogic.git
 $ cd RPi.GPIO-Amlogic
 $ sudo python3 setup.py clean --all
 $ sudo python3 setup.py install
```
Create and install wheel package
```sh
 $ sudo python3 setup.py bdist_wheel
 $ sudo pip3 install dist/RPi.GPIO-XXX.whl
```
Install from git source directly without development
```sh
 $ sudo pip3 install git+https://github.com/Dangku/RPi.GPIO-Amlogic.git
```
If the package is already installed, it should be uninstalled before installing the new one, or installing the new one with --force-reinstall option.

=== WiringPi2-Python

Build and install, for debian, you must link:https://newwiki.banana-pi.org/en/BPI-M5_M2_Pro/GettingStarted_BPI-M5_M2_Pro#_enable_sudo_for_debian[install sudo] before build
```
 $ sudo apt-get update
 $ sudo apt-get install build-essential python3 python3-dev python3-setuptools swig git
 $ git clone --recursive  https://github.com/Dangku/WiringPi2-Python-Amlogic.git
 $ cd WiringPi2-Python-Amlogic
 $ sudo python3 setup.py install
```











== Other Development

=== Enable sudo for Debian

The release Debian image do not install sudo default, with "su -" command, user can change to root. If you like sudo, you can install it.
```
 $ su root
 Password:(enter bananapi)
 
 # apt-get update
 # apt-get install sudo
 # adduser pi sudo
```
Then please do logout and login again


