= Introduction

BananaPi BPI-CM4 new design with Amlogic A311D Quad core ARM Cortex-A73 and dual core ARM Cortex-A53 CPU ,ARM G52 MP4(6EE) GPU,NPU for AI at 5.0 TOPS, support Camera and MIPI-CSI interface ,HDMI output,2 Gigabit port . 4G RAM and 16 GB eMMC flash.

TIP: More Infomation: link:/en/BPI-CM4/BananaPi_BPI-CM4[Banana Pi BPI-CM4]

= Development
== Prepare

. Prepare a usb-serial cable, a 5V/3A adaptor type-c power supply. The serial cable is used for console debug and type-c cable is used for android image download and ADB debug.
. Prepare a SDcard at least 8GB for linux development, android only support emmc boot.
. The SOC rom first boot media is emmc, so board can't bootup from SDcard if the emmc is bootable with any image flashed, more info please refer to board link:/en/BPI-CM4/GettingStarted_BPI-CM4#_boot_sequence[boot sequence].

== Android
=== Prepare

. Download and install the link:https://download.banana-pi.dev/d/3ebbfa04265d4dddb81b/files/?p=%2FTools%2Fimage_download_tools%2Faml_usb_burning_tool_V2_setup_v2.2.3.3.zip[AML Usb Burning Tool] for android image download via type-c, only support windows.
. Download the latest android image, and confirm that the md5 checksum is correct.

=== Install Image with Usb Burning Tool
. Open USB_Burning_Tool.exe, select menu File->Import image, and select android image.
+

. Short the usb boot test point on the main board, plugin type-c usb cable to PC or press the RST button if power adapter already connected, about two seconds later, the board will enter usb download mode and be identified correctly by PC. You can also enter usb download mode with adb command "adb reboot update" or console command "reboot update" if a bootable android already flashed, make sure typec usb connected to PC before doing this.
+
Cm4 usb download.jpg
+
M2s android install 3.png
+
M2s android install 2.png

. Click the Start button of the download tool and wait for upgrade complete.
+
M2s android install 4.png

. After Burning successfull, Unplug the type-c usb and connect to power supply adaptor to startup.
+
M2s android install 5.png

. Click the Stop button to cancel the upgrade process and close the USB Buring Tool.

=== Install Image with Aml Flash Tool
link:https://github.com/Dangku/aml-flash-tool[Aml-flash-tool] is a linux platform opensource image flash util for Amlogic android.
```sh
 $ ./flash-tool.sh --img=/path/to/aml_upgrade_package.img --parts=all --wipe --soc=g12a --reset=y
```

M5 linux flash.PNG

=== Build Android Source Code

. Get Android 9.0 source code:
+
https://github.com/BPI-SINOVOIP/BPI-A311D-Android9
+
or you can get the source code tar archive from link:https://pan.baidu.com/s/1rANGEB-1MLPCBXqOR5aYCg?pwd=8888[BaiduPan(pincode: 8888)] or link:https://drive.google.com/drive/folders/1INIABp_MbB5UcwfqujTngGLOZN7YGuWp?usp=share_link[GoogleDrive]

. Build the Android 9.0 Source code
Please read the source code link:https://github.com/BPI-SINOVOIP/BPI-A311D-Android9/blob/master/README.md[README.md]

=== Android DTB overlay[edit]
Bananapi CM4 DTBO idx value table, default idx value is 0 in release image.

[options="header",cols="1,2,3"]
|======
3+| Bananapi CM4 DTBO idx value table
| idx value  | device tree overlay | description                         
| 0          | android_p_overlay   | default dtbo, no use                
| 1          | wifi_bt_rtl8822cs   | enable bpi rtl8822cs wifi/bt module 
| 2          | i2c1                | enable i2c 1                        
| 3          | i2c2                | enable i2c 2                        
| 4          | sdio                | enable sdio                         
| 5          | uart1               | enable 2 pins uart 1                
| 6          | uart1_cts_rts       | enable 4 pins uart 1                
| 7          | uart2               | enable 2 pins uart 2                
| 8          | hifi_pcm5122        | enable i2s link:https://shumeipai.nxez.com/hifidac-hat-for-raspberry-pi[pcm5122 HiFi DAC]
|======

**How to apply a new dtbo**

. ADB command via sysfs
+
```sh
 root@dangku-desktop:/tmp# adb root
 restarting adbd as root
 root@dangku-desktop:/tmp# adb remount
 remount succeeded
 root@dangku-desktop:/tmp# adb shell
 bananapi_m2s:/ # echo dtbo > /sys/class/unifykeys/name
 bananapi_m2s:/ # echo "1" > /sys/class/unifykeys/write
 bananapi_m2s:/ # reboot
```
. Uart console command via sysfs
+
```sh
 console:/ $ 
 console:/ $ su
 console:/ # echo dtbo > /sys/class/unifykeys/name                              
 [  115.702781@0] unifykey: name_store() 1302, name dtbo, 4
 [  115.702856@0] unifykey: name_store() 1311
 console:/ #
 console:/ # echo "1" > /sys/class/unifykeys/write                              
 [  129.262659@0] unifykey: write_store()  is a string
 [  129.262733@0] unifykey: dtbo, 1, 1
 [  129.265312@0] unifykey: amlkey_write 393
 [  129.292347@1] emmc_key_write:149, write ok
 console:/ # 
 console:/ # reboot
```
. Settings App(To-Do)
+
Check the bootup uart debug message and confirm which dtbo is loaded actually, here "1" means set idx=1 to apply wifi_bt_rtl8822cs dtbo.
+
```sh
 load dtb from 0x1000000 ......
       Amlogic multi-dtb tool
       Single dtb detected
 find 2 dtbos
 dtbos to be applied: 1
 Apply dtbo 1
```
Unifykeys is stored in a specific emmc part, "Normal erase" selected in USB_Burning_Tool will not erase this data for next update, you must select "Erase all" if you want the default dtbo idx to be applied after image download.

**Build Android image with a specific DTBO default.**

. Default build-in overlays are defined in device/bananapi/bananapi_m2s/Kernel.mk, you can add a new overlay dtbo here.
+
```sh
 DTBO_DEVICETREE := android_p_overlay wifi_bt_rtl8822cs i2c1 i2c2 sdio uart1 uart1_cts_rts uart2 hifi_pcm5122
```
. Default apply DTBO idx is defined in device/bananapi/bananapi_m2s/BoardConfig.mk, you can change the idx value to set which overlay dtbo will be applied default.
+
```sh
 BOARD_KERNEL_CMDLINE += androidboot.dtbo_idx=0
```
. DTS files are in common/arch/arm64/boot/dts/amlogic/overlay/bananapi_m2s/
+
More info about android device tree overlays, please refer to link:https://source.android.com/devices/architecture/dto[google android offical site]

=== Install OpenGapps
. Download install package from link:https://opengapps.org/[OpenGapps], Android release image is arm/android 9.0 variant.
+
image::/picture/opengapps.png[opengapps.png]

. Download link:https://download.banana-pi.dev/d/ca025d76afd448aabc63/files/?p=%2FTools%2Fapps%2Fdevice_id_v1.3.2.apk[device_id.apk].
. Copy the OpenGapp package to a udisk or sdcard root directory.
. Create a txt file named factory_update_param.aml in udisk or sdcard root directory with the following android recovery parameter content, and replace the file name with the actual downloaded package.
+
udisk:
+
```sh
 --wipe_cache
 --update_package=/udisk/open_gapps-arm-9.0-pico-20210327.zip
```
sdcard:
+
```sh
 --wipe_cache
 --update_package=/sdcard/open_gapps-arm-9.0-pico-20210327.zip
```
. Plugin the udisk or sdcard to the board and poweron.
. OpenGapps install and certify.
+
YouTube : https://youtu.be/fXOKmWfpqF8
+
Bilibili: https://www.bilibili.com/video/BV13y4y1s77i/

=== Switch Mipi Panel
The default android release image only support one mipi panel because hw has no detect logic for different panel at boot, so [800x1280 bpi panel] enabled as default, but you can change to [1200x1920 bpi panel] as defualt in Settings->Panel Output

image::/picture/m2s_panel_switch.png[m2s_panel_switch.png]

=== Panel Rotation
The two 10" mipi panels are all portrait hw display, so the default android release image is portrait mode, but you can rotate it to 90/180/270 in two ways.

. UI Rotation in Settings->Display->Screen rotation
+
image::/picture/m2s-rotation.png[m2s-rotation.png]

. SurfaceFlinger rotation, need modify android source code and build
Change the default sf rotation property
   diff --git a/device/bananapi/bananapi_m2s/bananapi_m2s.mk b/device/bananapi/bananapi_m2s/bananapi_m2s.mk
   index 1f51703..d592a44 100644
   --- a/device/bananapi/bananapi_m2s/bananapi_m2s.mk
   +++ b/device/bananapi/bananapi_m2s/bananapi_m2s.mk
   @@ -579,6 +579,6 @@ PRODUCT_PROPERTY_OVERRIDES += \
    else
    PRODUCT_PROPERTY_OVERRIDES += \
        ro.sf.lcd_density=213 \
    -    ro.sf.primary_display_orientation=0
   +    ro.sf.primary_display_orientation=90
    endif
Change the touch panel rotation in dts
   diff --git a/common/arch/arm64/boot/dts/amlogic/bananapi_m2s.dts b/common/arch/arm64/boot/dts/amlogic/bananapi_m2s.dts
   index 4a698b0..3d41b63 100755
   --- a/common/arch/arm64/boot/dts/amlogic/bananapi_m2s.dts
   +++ b/common/arch/arm64/boot/dts/amlogic/bananapi_m2s.dts
   @@ -876,8 +876,8 @@
                   reg = <0x5d>;
                   reset-gpio = <&gpio GPIOA_6 GPIO_ACTIVE_HIGH>;
                   irq-gpio = <&gpio GPIOA_5 GPIO_ACTIVE_HIGH>;
   -               rotation = <4>; /* sf_rotation 0 */
   -               //rotation = <0>; /* sf_rotation 90*/
  +               //rotation = <4>; /* sf_rotation 0 */
  +               rotation = <0>; /* sf_rotation 90*/
                   //rotation = <5>; /* sf_rotation 180 */
                   //rotation = <3>; /* sf_rotation 270 */
Custom Android Boot Logo
Android bootloader limit boot logo fb display size is 1080p60hz/1920x1080 default, and android kernel dtb partition table limit boot logo partition size to 16MB default .
1. Prepare a 16bit bmp file and named boot-logo.bmp
2. Compress the bmp file to boot-logo.bmp.gz
 $ gzip boot-logo.bmp
3. Download m2s_android_bootlogo_tool.zip
4. Extract this tool
 $ unzip m2s_android_bootlogo_tool.zip
 $ cd m2s_android_bootlogo_tool/
 $ ls -l logo/
 -rwxr--r-- 1 dangku dangku 525054 Sep 25 16:54 bootup.bmp
 -rwxr--r-- 1 dangku dangku 525054 Sep 25 16:54 bootup_secondary.bmp
 -rwxr--r-- 1 dangku dangku    184 May 19  2020 upgrade_bar.bmp
 -rwxr--r-- 1 dangku dangku 180072 May 19  2020 upgrade_error.bmp
 -rwxr--r-- 1 dangku dangku 180072 May 19  2020 upgrade_fail.bmp
 -rwxr--r-- 1 dangku dangku 180072 May 19  2020 upgrade_logo.bmp
 -rwxr--r-- 1 dangku dangku 180072 May 19  2020 upgrade_success.bmp
 -rwxr--r-- 1 dangku dangku    184 May 19  2020 upgrade_unfocus.bmp
 -rwxr--r-- 1 dangku dangku 180072 May 19  2020 upgrade_upgrading.bmp
5. Copy the boot-logo.bmp.gz
 $ cp boot-logo.bmp.gz logo/bootup.bmp
 $ cp boot-logo.bmp.gz logo/bootup_secondary.bmp
6. Create target logo.img with img pack tool, the binary and related libs of m2s_android_bootlogo_tool are copy from <android-source-dir>/out/host/linux-x86
 $ ./logo_img_packer -r logo logo.img
7. Flash boot logo with fastboot
 $ adb root
 $ adb remount
 $ adb reboot fastboot
Wait few seconds and check whether fastboot connected
 $ fastboot device
 1234567890      fastboot
 $ fastboot flashing unlock_critical
 $ fastboot flashing unlock
 $ fastboot flash logo logo.img
 $ fastboot reboot
 
== Linux
=== Prepare

. xxx
. xxx
. xxx
. xxx

=== Install Image with xxx

. xxx
. xxx
. xxx
. xxx

=== Install Image with xxx

. xxx
. xxx
. xxx
. xxx
